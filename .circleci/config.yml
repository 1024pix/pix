# .circleci/config.yml
#
# This file configures the CircleCI 2.0 build.
#
# Documentation:
# - Overview: https://circleci.com/docs/2.0/workflows/
# - Caching: https://circleci.com/docs/2.0/caching/
#
# Things to know:
# - every job is a container
# - the file `.circle-cache-key` is used to have a common key between different containers of same build
# - we need cache, everywhere for everything
# - cache is immutable. Sometimes we need to flush the cache, but we can't. That's why there is this
# `v1-` at the beginning. Increment it to `v1-` when you need to change the cache content
#
# Cached entries (lifetime = months):
# - `v1-pix-{{ checksum ".circle-cache-key" }}`                  => the source code
# - `v1-api-dependencies-{{ checksum "package.json" }}` => `pix/api/node_modules` directory
# - `v1-mon_pix-dependencies-{{ checksum "package.json" }}` => `pix/mon-pix/{node_modules, bower_components}` directories
#
# Workspace entries (lifetime = workflow):
# - `~/pix/mon-pix/dist`                                      => `pix/mon-pix/dist` directory

common_properties: &common_properties
  docker:
    - image: circleci/node:8
  working_directory: ~/pix

# Properties shared by all api-side jobs
api_properties: &api_properties
  docker:
    - image: circleci/node:8
  working_directory: ~/pix/api

# Properties shared by all mon_pix-side jobs
mon_pix_properties: &mon_pix_properties
  docker:
    - image: circleci/node:8-browsers
  working_directory: ~/pix/mon-pix

# Properties shared by all orga-side jobs
orga_properties: &orga_properties
  docker:
    - image: circleci/node:8-browsers
  working_directory: ~/pix/orga

version: 2.0

workflows:
  version: 2
  build-test-and-deploy:
    jobs:
      # Common
      - checkout_code:
          filters:
            branches:
              ignore:
                - master
                - math
                - preview
                - gh-pages
                - /release-.*/

      # api side
      - install_api_dependencies:
          requires:
            - checkout_code
      - test_api:
          requires:
            - install_api_dependencies
      # mon_pix side
      - install_mon_pix_dependencies:
          requires:
            - checkout_code
      - test_mon_pix_1:
          requires:
            - install_mon_pix_dependencies
      - test_mon_pix_2:
          requires:
            - install_mon_pix_dependencies
      - test_mon_pix_3:
          requires:
            - install_mon_pix_dependencies

      # orga side
      - install_orga_dependencies:
          requires:
            - checkout_code
      - test_orga:
          requires:
            - install_orga_dependencies

      - signal_ci_ok:
          requires:
            - test_api
            - test_mon_pix_1
            - test_mon_pix_2
            - test_mon_pix_3
            - test_orga
          filters:
            branches:
              ignore:
                - dev

jobs:
  # Common
  checkout_code:
    <<: *common_properties
    steps:
      - checkout
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - save_cache:
          key: v5-pix-{{ checksum ".circle-cache-key" }}
          paths:
            - ~/pix

  # api
  install_api_dependencies:
    <<: *api_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-api-dependencies-{{ checksum "package.json" }}
      - run: npm install
      - save_cache:
          key: v5-api-dependencies-{{ checksum "package.json" }}
          paths:
            - ~/pix/api/node_modules
            - ~/pix/.npm
  test_api:
    docker:
      - image: circleci/node:8
      - image: postgres:10-alpine
        environment:
          POSTGRES_USER: circleci
    working_directory: ~/pix/api
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-api-dependencies-{{ checksum "package.json" }}
      - run:
          command: |
            npm run lint
            npm test
          environment:
            DATABASE_URL: "postgres://circleci@localhost:5432/circleci"

  # mon_pix
  install_mon_pix_dependencies:
    <<: *mon_pix_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-mon_pix-dependencies-{{ checksum ".circle-cache-key" }}
            #- v5-mon_pix-dependencies-{{ checksum "package.json" }} # FIXME restore shared cache between builds
      - run: npm install
      - run: |
          if [ "${CIRCLE_BRANCH}" == "dev" ]; then
            npx ember build --environment staging
          else
            npx ember build --environment integration
          fi
      - persist_to_workspace:
          root: ~/pix/mon-pix
          paths:
            - dist
      - save_cache:
          key: v5-mon_pix-dependencies-{{ checksum ".circle-cache-key" }}
          paths:
            - ~/pix/mon-pix/node_modules
            - ~/.npm

  test_mon_pix_1:
    <<: *mon_pix_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-mon_pix-dependencies-{{ checksum ".circle-cache-key" }}
      - attach_workspace:
          at: ~/pix/mon-pix
      - run: npx ember exam --path dist --split=3 --partition=1 --reporter dot

  test_mon_pix_2:
    <<: *mon_pix_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-mon_pix-dependencies-{{ checksum ".circle-cache-key" }}
      - attach_workspace:
          at: ~/pix/mon-pix
      - run: npx ember exam --path dist --split=3 --partition=2 --reporter dot

  test_mon_pix_3:
    <<: *mon_pix_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-mon_pix-dependencies-{{ checksum ".circle-cache-key" }}
      - attach_workspace:
          at: ~/pix/mon-pix
      - run: npx ember exam --path dist --split=3 --partition=3 --reporter dot

  # orga
  install_orga_dependencies:
    <<: *orga_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          keys:
            - v5-orga-dependencies-{{ checksum ".circle-cache-key" }}
            #- v5-orga-dependencies-{{ checksum "package.json" }} # FIXME restore shared cache between builds
      - run: npm install
      - run: |
          if [ "${CIRCLE_BRANCH}" == "dev" ]; then
            npx ember build --environment staging
          else
            npx ember build --environment integration
          fi
      - persist_to_workspace:
          root: ~/pix/orga
          paths:
            - dist
      - save_cache:
          key: v5-orga-dependencies-{{ checksum ".circle-cache-key" }}
          paths:
            - ~/pix/orga/node_modules
            - ~/.npm

  test_orga:
    <<: *orga_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - restore_cache:
          key:
            - v5-orga-dependencies-{{ checksum ".circle-cache-key" }}
      - run: npm test

  signal_ci_ok:
    <<: *common_properties
    steps:
      - run: echo "${CIRCLE_BRANCH}_${CIRCLE_SHA1}" > .circle-cache-key
      - restore_cache:
          keys:
            - v5-pix-{{ checksum ".circle-cache-key" }}
      - run: sudo apt-get install -y jq
      - run: ~/pix/mon-pix/scripts/jira/comment_with_review_app_url.sh
      - run: ~/pix/mon-pix/scripts/signal_deploy_to_pr.sh
