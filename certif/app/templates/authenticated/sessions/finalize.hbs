{{page-title this.pageTitle replace=true}}
<div class="page__title finalize">
  <div class="finalize__title">
    <PixReturnTo @route="authenticated.sessions.details" @model={{this.session.id}}>
      Retour à la session
    </PixReturnTo>
    <h1 class="page-title">Finaliser la session {{this.session.id}}</h1>
  </div>
  <div class="finalize__subtitle">
    Pour finaliser la session, complétez les trois étapes puis validez.
  </div>

  <SessionFinalizationStepContainer
    @number="1"
    @title="Reporter, pour chaque candidat, les signalements renseignés sur le PV d'incident"
    @icon="/icons/session-finalization-user.svg"
    @iconAlt=""
  >
    {{#if (gt this.session.uncompletedCertificationReports.length 0)}}
      <SessionFinalization::UncompletedReportsInformationStep
        @certificationReports={{this.session.uncompletedCertificationReports}}
        @issueReportDescriptionMaxLength={{this.issueReportDescriptionMaxLength}}
        @onIssueReportDeleteButtonClicked={{this.deleteCertificationIssueReport}}
        @onChangeAbortReason={{this.abort}}
      />
    {{/if}}
    {{#if (gt this.session.completedCertificationReports.length 0)}}
      <SessionFinalization::CompletedReportsInformationStep
        @session={{this.session}}
        @certificationReports={{this.session.completedCertificationReports}}
        @issueReportDescriptionMaxLength={{this.issueReportDescriptionMaxLength}}
        @onHasSeenEndTestScreenCheckboxClicked={{this.toggleCertificationReportHasSeenEndTestScreen}}
        @onAllHasSeenEndTestScreenCheckboxesClicked={{this.toggleAllCertificationReportsHasSeenEndTestScreen}}
        @onIssueReportDeleteButtonClicked={{this.deleteCertificationIssueReport}}
        @shouldDisplayHasSeenEndTestScreenCheckbox={{this.shouldDisplayHasSeenEndTestScreenCheckbox}}
      />
    {{/if}}
  </SessionFinalizationStepContainer>

  {{#if this.shouldDisplayFormStep}}
    <SessionFinalizationStepContainer
      @number="2"
      @title="Transmettre des documents (facultatif)"
      @icon="/icons/session-finalization-send.svg"
      @iconAlt=""
    >
      <SessionFinalization::FormbuilderLinkStep />
    </SessionFinalizationStepContainer>
  {{/if}}

  <SessionFinalizationStepContainer
    @number="3"
    @title="Commenter la session (facultatif)"
    @icon="/icons/session-finalization-edit.svg"
    @iconAlt=""
  >
    <SessionFinalization::ExaminerGlobalCommentStep
      @session={{this.session}}
      @examinerGlobalCommentMaxLength={{this.examinerGlobalCommentMaxLength}}
      @onExaminerGlobalCommentChange={{this.updateExaminerGlobalComment}}
    />
  </SessionFinalizationStepContainer>

  <PixButton class="finalize__button" data-test-id="finalize__button" @triggerAction={{this.openModal}}>
    Finaliser
  </PixButton>
</div>

{{#if this.showConfirmModal}}
  <SessionFinalization::FinalizationConfirmationModal
    @closeModal={{this.closeModal}}
    @hasUncheckedHasSeenEndTestScreen={{this.hasUncheckedHasSeenEndTestScreen}}
    @uncheckedHasSeenEndTestScreenCount={{this.uncheckedHasSeenEndTestScreenCount}}
    @shouldDisplayHasSeenEndTestScreenCheckbox={{this.shouldDisplayHasSeenEndTestScreenCheckbox}}
    @finalizeSession={{this.finalizeSession}}
  />
{{/if}}