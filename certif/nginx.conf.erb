set $maintenance_mode <%= ENV['MAINTENANCE'] %>;

# in case of 503, serve this URI
error_page 503 /maintenance_page.html;
location = /maintenance_page.html {
    # maintenance page is at the root of the project
    root /app/;
}

location / {
  if ($maintenance_mode = enabled) {
        return 503;
  }

  root /app/dist/;

  try_files $uri /index.html =404;
}

location /api/ {
  <%
  # We compute the API host from the front app name, examples:
  #   pix-certif-integration       -> pix-certif-integration.scalingo.io
  #   pix-certif-integration-pr123 -> pix-certif-integration-pr123.scalingo.io
  #   pix-certif-production        -> pix-certif-production.scalingo.io
  %>
  proxy_pass https://<%= ENV['APP'].gsub(/-certif-/, "-api-") %>.scalingo.io;
  proxy_redirect default;
}
